{% extends "base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
    .stat-box { border-radius: 15px; transition: 0.3s; border-left: 6px solid; min-height: 120px; background-color: #fff; }
    .stat-box:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
    .border-success { border-left-color: #198754 !important; } /* ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… */
    .border-primary { border-left-color: #0d6efd !important; } /* ØªØ¬Ù‡ÙŠØ² */
    .border-warning { border-left-color: #ffc107 !important; } /* Ø§Ù†ØªØ¸Ø§Ø± */
    .border-danger { border-left-color: #dc3545 !important; }  /* Ù…Ù„ØºÙŠ */
    .border-info { border-left-color: #0dcaf0 !important; }    /* Ø§Ù„Ø²ÙˆØ§Ø± */
</style>

<div class="container py-5" dir="rtl text-end">
    <h2 class="mb-5 text-center fw-bold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>

    <div class="row g-4 mb-5 text-end">
        <div class="col-md-3">
            <div class="card shadow p-3 stat-box border-success">
                <p class="text-secondary mb-1 small fw-bold text-end">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                <h2 class="text-success text-end">{{ total_revenue|floatformat:0 }} <span class="fs-6 text-muted">Ø¯.Ù„</span></h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow p-3 stat-box border-info">
                <p class="text-secondary mb-1 small fw-bold text-end">ğŸ‘€ Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªØ¬Ø±</p>
                <h2 class="text-info text-end">{{ visits_count }} <span class="fs-6 text-muted">Ø²ÙŠØ§Ø±Ø©</span></h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow p-3 stat-box border-warning">
                <p class="text-secondary mb-1 small fw-bold text-end">ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                <h2 class="text-warning text-end">{{ total_orders }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow p-3 stat-box border-danger">
                <p class="text-secondary mb-1 small fw-bold text-end">âŒ Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºØ§Ø©</p>
                <h2 class="text-danger text-end">{{ cancelled_orders.count }}</h2>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="card shadow border-0 rounded-4 h-100">
                <div class="card-header bg-white fw-bold py-3 border-bottom-0">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)</div>
                <div class="card-body">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow border-0 rounded-4 h-100">
                <div class="card-header bg-white fw-bold py-3 border-bottom-0">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</div>
                <div class="card-body">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-danger text-white fw-bold py-3 text-end">
            ğŸ“‰ Ø³Ø¬Ù„ Ø¢Ø®Ø± 5 Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºØ§Ø© ÙˆØ£Ø³Ø¨Ø§Ø¨Ù‡Ø§
        </div>
        <div class="table-responsive">
            <table class="table table-hover text-center align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
                        <th class="text-end px-4">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in cancelled_orders %}
                    <tr>
                        <td class="fw-bold">#{{ order.id }}</td>
                        <td>{{ order.first_name }} {{ order.last_name }}</td>
                        <td class="text-end px-4">
                            <span class="badge bg-danger-subtle text-danger p-2 rounded-3 fw-normal">
                                {{ order.cancellation_reason|default:"Ù„Ù… ÙŠØªÙ… Ø°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨" }}
                            </span>
                        </td>
                        <td class="small text-muted">{{ order.created_at|date:"d-m-Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="py-5 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºØ§Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusData = {{ status_counts|safe }};
    const pNames = {{ product_names_for_chart|safe }};
    const pSales = {{ product_sales_for_chart|safe }};

    // 1. Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const ctx1 = document.getElementById('orderStatusChart');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusData), // Ø§Ù†ØªØ¸Ø§Ø±ØŒ ØªØ¬Ù‡ÙŠØ²ØŒ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŒ Ù…Ù„ØºÙŠ
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: [
                    '#ffc107', // Ø§Ù†ØªØ¸Ø§Ø± -> Ø£ØµÙØ±
                    '#0d6efd', // ØªØ¬Ù‡ÙŠØ² -> Ø£Ø²Ø±Ù‚
                    '#198754', // ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… -> Ø£Ø®Ø¶Ø±
                    '#dc3545'  // Ù…Ù„ØºÙŠ -> Ø£Ø­Ù…Ø±
                ],
                hoverOffset: 10
            }]
        },
        options: { 
            plugins: { 
                legend: { position: 'bottom', rtl: true, labels: { boxWidth: 15, padding: 20 } } 
            }
        }
    });

    // 2. Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø´Ø±ÙŠØ·ÙŠ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
    const ctx2 = document.getElementById('topProductsChart');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: pNames,
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡',
                data: pSales,
                backgroundColor: '#6610f2', // Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ù…ÙŠØ²
                borderRadius: 8
            }]
        },
        options: { 
            indexAxis: 'y', 
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });
});
</script>
{% endblock %}