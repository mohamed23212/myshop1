{% extends "base.html" %}
{% block title %}ğŸ“¦ ØªØªØ¨Ø¹ Ø·Ù„Ø¨ÙŠ Ø±Ù‚Ù… #{{ group.id }}{% endblock %}

{% block content %}
<style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© */
    body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªØªØ¨Ø¹ */
    .stepper-wrapper { display: flex; justify-content: space-between; margin-top: 20px; position: relative; }
    .stepper-item { position: relative; display: flex; flex-direction: column; align-items: center; flex: 1; z-index: 2; }
    .stepper-item::before { position: absolute; content: ""; border-bottom: 4px solid #eee; width: 100%; top: 22px; right: -50%; z-index: -1; }
    .stepper-item::after { position: absolute; content: ""; border-bottom: 4px solid transparent; width: 0%; top: 22px; right: -50%; z-index: -1; transition: width 0.6s ease-in-out, border-color 0.6s; }
    .step-pending::after { width: 100%; border-color: #ffc107 !important; }
    .step-processing::after { width: 100%; border-color: #0d6efd !important; }
    .stepper-item:first-child::before, .stepper-item:first-child::after { content: none; }
    .step-counter { width: 45px; height: 45px; border-radius: 50%; background: #fff; border: 2px solid #eee; display: flex; justify-content: center; align-items: center; transition: 0.4s; font-size: 1.2rem; color: #ccc; }
    .active-pending .step-counter { border-color: #ffc107; color: #ffc107; }
    .active-processing .step-counter { border-color: #0d6efd; color: #0d6efd; }
    .active-delivered .step-counter { border-color: #198754; color: #fff; background: #198754; }
    .step-name { font-size: 12px; margin-top: 8px; font-weight: bold; color: #bbb; }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    .total-box-luxury { background: linear-gradient(135deg, #f0f7ff 0%, #e1effe 100%); border: 2px solid #0056b3; border-radius: 15px; padding: 15px; text-align: center; }
    .text-custom-blue { color: #0056b3; }

    /* Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; flex-shrink: 0; }
    .main-table th { white-space: nowrap; padding: 12px 8px !important; }
    .product-info-wrapper { display: flex; align-items: center; gap: 10px; min-width: 150px; }

    /* Ù‚Ø³Ù… Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
    .wa-confirmation-card { background: #fff; border-radius: 20px; border: 1px solid #e0e0e0; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

    @media (max-width: 768px) {
        .main-table thead { display: none; }
        .main-table tr { display: block; margin-bottom: 15px; border: 1px solid #eee; border-radius: 15px; padding: 10px; background: #fff; }
        .main-table td { display: flex; justify-content: space-between; align-items: center; border: none; padding: 8px 5px !important; text-align: left !important; }
        .main-table td::before { content: attr(data-label); font-weight: bold; color: #666; font-size: 13px; }
        .product-cell { flex-direction: column; align-items: flex-start !important; }
        .product-cell::before { margin-bottom: 5px; }
    }
</style>

<div class="container my-4" dir="rtl">

    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body py-4 px-2">
            <div class="stepper-wrapper">
                <div class="stepper-item active-pending {% if group.status != 'CANCELLED' %}step-pending{% endif %}">
                    <div class="step-counter"><i class="bi bi-clock-history"></i></div>
                    <div class="step-name" style="color:#ffc107">Ø§Ù†ØªØ¸Ø§Ø±</div>
                </div>
                <div class="stepper-item {% if group.status == 'PROCESSING' or group.status == 'DELIVERED' %}active-processing step-processing{% endif %}">
                    <div class="step-counter"><i class="bi bi-gear-wide-connected"></i></div>
                    <div class="step-name" {% if group.status == 'PROCESSING' %}style="color:#0d6efd"{% endif %}>ØªØ¬Ù‡ÙŠØ²</div>
                </div>
                <div class="stepper-item {% if group.status == 'DELIVERED' %}active-delivered{% endif %}">
                    <div class="step-counter"><i class="bi bi-truck"></i></div>
                    <div class="step-name" {% if group.status == 'DELIVERED' %}style="color:#198754"{% endif %}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-4 overflow-hidden mb-4">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3 px-3">
             <span class="fw-bold fs-5 text-dark">#{{ group.id }}</span>
             <span class="badge px-3 py-2 rounded-pill {% if group.status == 'PENDING' %}bg-warning text-dark{% elif group.status == 'PROCESSING' %}bg-primary{% elif group.status == 'DELIVERED' %}bg-success{% elif group.status == 'CANCELLED' %}bg-danger{% endif %}">
                {{ group.get_status_display }}
             </span>
        </div>
        
        <div class="card-body p-3 text-end">
            <div class="row g-3 mb-4 text-end">
                <div class="col-12">
                    <div class="p-3 border rounded-4 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold mb-0 text-secondary small"><i class="bi bi-geo-alt-fill me-1"></i>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…</h6>
                            {% if group.status == 'PENDING' %}
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-2 py-0" data-bs-toggle="modal" data-bs-target="#editInfoModal" style="font-size: 11px;">ØªØ¹Ø¯ÙŠÙ„</button>
                            {% endif %}
                        </div>
                        <div class="fw-bold small mb-1">{{ group.first_name }} {{ group.last_name }}</div>
                        <div class="small text-dark mb-1"><i class="bi bi-telephone text-muted"></i> {{ group.phone_number }}</div>
                        <div class="small text-dark"><i class="bi bi-truck text-muted"></i> Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: {{ group.get_delivery_method_display }}</div>
                        {% if group.delivery_method == 'delivery' %}
                        <div class="small text-dark"><i class="bi bi-map text-muted"></i> {{ group.address }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-12 text-center">
                    <div class="total-box-luxury">
                        <div class="text-muted small fw-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                        <div class="fs-3 fw-bold text-custom-blue">{{ group.total|floatformat:0 }} <small class="fs-6">Ø¯.Ù„</small></div>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mb-3"><i class="bi bi-box-seam me-1"></i> Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨:</h6>
            <div class="table-responsive border rounded-3">
                <table class="table align-middle main-table mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50%;">Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th class="text-center">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in group.orders.all %}
                        <tr>
                            <td class="product-cell" data-label="Ø§Ù„Ù…Ù†ØªØ¬">
                                <div class="product-info-wrapper text-end">
                                    {% if order.product and order.product.image %}
                                        <img src="{{ order.product.image.url }}" class="product-img">
                                    {% else %}
                                        <div class="product-img bg-light d-flex align-items-center justify-content-center"><i class="bi bi-image text-muted"></i></div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-bold text-dark" style="font-size: 13px; line-height: 1.2;">{{ order.product_name }}</div>
                                        <small class="text-muted">{{ order.price|floatformat:0 }} Ø¯.Ù„</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center" data-label="Ø§Ù„ÙƒÙ…ÙŠØ©">
                                <span class="badge bg-white text-dark border px-2 py-1">{{ order.quantity }}</span>
                            </td>
                            <td class="text-center fw-bold text-custom-blue" data-label="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹">
                                {{ order.total|floatformat:0 }} Ø¯.Ù„
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="wa-confirmation-card mt-4 text-center">
        <div class="alert alert-warning border-0 shadow-sm rounded-4 py-2 px-3 mb-3 text-center" style="font-size: 13px; background-color: #fff9e6; color: #856404; border-right: 5px solid #ffc107 !important;">
            <i class="bi bi-exclamation-triangle-fill me-1 text-warning"></i>
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ.
        </div>
        
        <div class="d-flex justify-content-center">
            <a id="wa_confirm_btn" href="#" target="_blank" 
               class="btn btn-success py-2 px-5 fw-bold rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2"
               style="font-size: 16px; background-color: #25D366; border: none; min-width: 250px; max-width: 80%;">
                <i class="bi bi-whatsapp fs-4"></i>
                <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
            </a>
        </div>

        {% if group.status == 'PENDING' %}
        <div class="text-center mt-4">
            <button class="btn btn-link btn-sm text-danger text-decoration-none fw-bold" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                <i class="bi bi-x-circle me-1"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            </button>
        </div>
        {% endif %}
    </div>
</div>

{% if group.status == 'PENDING' %}
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow text-end" dir="rtl">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-danger" id="cancelOrderModalLabel">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</h5>
                <button type="button" class="btn-close ms-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'cancel_order' group.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-body py-0">
                    <p class="text-muted small">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                    <div class="mb-3">
                        <label for="cancellation_reason" class="form-label fw-bold small">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                        <textarea name="cancellation_reason" id="cancellation_reason" class="form-control rounded-3" rows="3" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-top-0 justify-content-start">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ØªØ±Ø§Ø¬Ø¹</button>
                    <button type="submit" class="btn btn-danger rounded-pill px-4 fw-bold">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const orderId = "{{ group.id }}";
        const fullName = "{{ group.first_name }} {{ group.last_name }}";
        const phone = "{{ group.phone_number }}";
        const total = "{{ group.total|floatformat:0 }}";
        const currentUrl = window.location.href;
        
        const methodRaw = "{{ group.delivery_method }}";
        let deliveryMethodStr = (methodRaw === 'delivery') ? "ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹" : "Ù…Ù† Ø§Ù„Ù…Ø­Ù„";
        
        let message = `ğŸ“¦ *ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… #${orderId}*\n\n`;
        message += `ğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* ${fullName}\n`;
        message += `ğŸ“ *Ø§Ù„Ù‡Ø§ØªÙ:* ${phone}\n`;
        message += `ğŸšš *Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:* ${deliveryMethodStr}\n`;
        
        if (methodRaw === 'delivery') {
            const address = "{{ group.address }}";
            message += `ğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}\n`;
        }

        message += `\nğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* ${total} Ø¯.Ù„\n`;
        message += `ğŸ”— *Ø±Ø§Ø¨Ø· ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨:* ${currentUrl}`;

        const whatsappNumber = "218942950095"; 
        const encodedMessage = encodeURIComponent(message);
        document.getElementById('wa_confirm_btn').href = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
    });
</script>

{% endblock %}